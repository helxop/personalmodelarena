<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Battle Arena & Ranking</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --header-bg: #1a1a1a;
            --border-color: #333;
            --text-color: #e0e0e0;
            --text-muted: #888;
            --primary-color: #4a90e2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --rank1-color: #ffd700;
            --rank2-color: #c0c0c0;
            --rank3-color: #cd7f32;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        html { box-sizing: border-box; scroll-behavior: smooth; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding-top: 130px;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 20px;
            z-index: 1000;
        }
        .header-top, .header-actions, .ranking-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header-top { margin-bottom: 10px; }
        .ranking-selector { justify-content: center; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary-color); }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover { opacity: 0.9; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }

        .segmented-control { display: flex; border: 1px solid var(--border-color); border-radius: 5px; overflow: hidden; }
        .segmented-control .btn { background-color: transparent; border-radius: 0; color: var(--text-muted); }
        .segmented-control .btn.active { background-color: var(--primary-color); color: white; }

        main { padding: 20px; display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 1200px) { main { grid-template-columns: 450px 1fr; } }

        #leaderboard-section h2 { margin-top: 0; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .leaderboard-controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .sort-btn { background-color: var(--card-bg); color: var(--text-muted); border: 1px solid var(--border-color); }
        .sort-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .sort-btn span { font-size: 0.8em; margin-left: 5px; }
        #leaderboard-container { list-style: none; padding: 0; margin: 0; }
        #leaderboard-container li { display: flex; align-items: center; background-color: var(--card-bg); margin-bottom: 8px; padding: 10px 15px; border-radius: 5px; border-left: 5px solid transparent; }
        #leaderboard-container .rank { font-size: 1.2rem; font-weight: bold; width: 40px; text-align: center; flex-shrink: 0; }
        .rank-1 { border-left-color: var(--rank1-color); } .rank-1 .rank { color: var(--rank1-color); }
        .rank-2 { border-left-color: var(--rank2-color); } .rank-2 .rank { color: var(--rank2-color); }
        .rank-3 { border-left-color: var(--rank3-color); } .rank-3 .rank { color: var(--rank3-color); }
        #leaderboard-container .model-details { flex-grow: 1; padding-left: 15px; }
        #leaderboard-container .model-name { font-weight: bold; word-break: break-all; margin-bottom: 5px; }
        #leaderboard-container .stats-row { display: flex; flex-flow: row wrap; justify-content: space-between; gap: 10px; color: var(--text-muted); font-size: 0.9em; }
        #leaderboard-container .rating { font-weight: bold; color: var(--primary-color); }

        #editor-container .empty-state { text-align: center; padding: 40px; border: 2px dashed var(--border-color); border-radius: 8px; color: var(--text-muted); }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border-color); }
        .card-header h3 { margin: 0; font-size: 1rem; color: var(--text-muted); }
        .card-body { padding: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-muted); }
        input[type="text"], textarea { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 5px; font-family: inherit; }
        textarea { resize: vertical; min-height: 60px; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.7); }
        .modal-content { background-color: var(--card-bg); margin: 10% auto; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; width: 80%; max-width: 700px; display: flex; flex-direction: column; }
        .modal-content h2 { margin-top: 0; }
        #json-output { flex-grow: 1; height: 400px; margin-bottom: 15px; font-family: "Courier New", Courier, monospace; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
    </style>
</head>
<body>
    <datalist id="model-names-list"></datalist>
    <input type="file" id="file-input" accept=".json,application/json" style="display:none;">

    <header class="header">
        <div class="header-top">
            <h1>LLM Battle Arena</h1>
            <div class="ranking-selector segmented-control">
                <button id="select-bt" class="btn active" onclick="setRankingSystem('bt')">Bradley-Terry</button>
                <button id="select-elo" class="btn" onclick="setRankingSystem('elo')">ELO</button>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn" onclick="document.getElementById('file-input').click()">Load File</button>
            <button class="btn btn-primary" onclick="addEntry()">+ Add Entry</button>
            <button class="btn btn-success" onclick="processDataAndRender()">Calculate Ratings</button>
            <button class="btn" onclick="showExportModal()">View / Export</button>
        </div>
    </header>

    <main>
        <section id="leaderboard-section">
            <h2>üèÜ Leaderboard</h2>
            <div class="leaderboard-controls">
                <button class="sort-btn" onclick="setSortOrder('rating')">Rating <span></span></button>
                <button class="sort-btn" onclick="setSortOrder('wins')">Wins <span></span></button>
                <button class="sort-btn" onclick="setSortOrder('losses')">Losses <span></span></button>
                <button class="sort-btn" onclick="setSortOrder('ties')">Ties <span></span></button>
                <button class="sort-btn" onclick="setSortOrder('matches')">Matches <span></span></button>
                <button class="sort-btn" onclick="setSortOrder('winrate')">Winrate <span></span></button>
            </div>
            <ul id="leaderboard-container"></ul>
        </section>

        <section id="editor-section">
            <div id="editor-container"></div>
        </section>
    </main>

    <div id="export-modal" class="modal">
        <div class="modal-content">
            <h2>Generated JSON</h2>
            <textarea id="json-output" readonly></textarea>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="exportToFile()">Download File</button>
                <button class="btn btn-primary" onclick="copyJsonToClipboard(this)">Copy</button>
                <button class="btn btn-danger" onclick="closeExportModal()">Close</button>
            </div>
        </div>
    </div>

    <script>

        const BT_ITERATIONS = 100;
        const ELO_K_FACTOR = 32;
        const DEFAULT_RATING = 1500;

        let jsonData = [];
        let currentSortKey = 'rating';
        let sortDirection = 'desc';
        let currentRankingSystem = 'bt';

        const editorContainer = document.getElementById('editor-container');
        const leaderboardContainer = document.getElementById('leaderboard-container');
        const fileInput = document.getElementById('file-input');
        const exportModal = document.getElementById('export-modal');
        const jsonOutput = document.getElementById('json-output');
        const modelDatalist = document.getElementById('model-names-list');

        function getInitialStats(battles) {
            const stats = {};
            const models = new Map(); 
            battles.forEach(b => {
                const modelA = b.match?.model_a?.trim();
                const modelB = b.match?.model_b?.trim();
                if(modelA && !models.has(modelA.toLowerCase())) models.set(modelA.toLowerCase(), modelA);
                if(modelB && !models.has(modelB.toLowerCase())) models.set(modelB.toLowerCase(), modelB);
            });
            models.forEach((originalCase, lowerCase) => {
                stats[lowerCase] = { name: originalCase, rating: DEFAULT_RATING, wins: 0, losses: 0, ties: 0, matches: 0 };
            });
            return stats;
        }

        function calculateBradleyTerryRatings(initialStats, battles) {
            const stats = JSON.parse(JSON.stringify(initialStats)); 
            const models = Object.keys(stats);
            if (models.length === 0) return {};

            const matchups = {};
            const effectiveWins = {};
            models.forEach(m => { 
                effectiveWins[m] = 0;
                matchups[m] = {};
            });

            battles.forEach(b => {
                const model_a = b.match?.model_a?.trim().toLowerCase();
                const model_b = b.match?.model_b?.trim().toLowerCase();
                const winner = b.winner?.trim().toLowerCase();
                if (!model_a || !model_b || !winner || !stats[model_a] || !stats[model_b]) return;

                if (!matchups[model_a][model_b]) matchups[model_a][model_b] = 0;
                if (!matchups[model_b][model_a]) matchups[model_b][model_a] = 0;
                matchups[model_a][model_b]++;
                matchups[model_b][model_a]++;

                if (winner === model_a) { stats[model_a].wins++; stats[model_b].losses++; effectiveWins[model_a]++; } 
                else if (winner === model_b) { stats[model_b].wins++; stats[model_a].losses++; effectiveWins[model_b]++; }
                else if (winner === 'tie') { stats[model_a].ties++; stats[model_b].ties++; effectiveWins[model_a] += 0.5; effectiveWins[model_b] += 0.5; }
                stats[model_a].matches++; stats[model_b].matches++;
            });

            let strengths = {};
            models.forEach(m => { strengths[m] = 1.0; });

            for (let i = 0; i < BT_ITERATIONS; i++) {
                const newStrengths = {};
                models.forEach(m => {
                    let denominator = 0;
                    for (const opponent in matchups[m]) {
                        denominator += matchups[m][opponent] / (strengths[m] + strengths[opponent]);
                    }
                    newStrengths[m] = denominator > 0 ? effectiveWins[m] / denominator : 0;
                });
                strengths = newStrengths;
            }

            models.forEach(m => {
                stats[m].rating = strengths[m] > 0 ? Math.round(DEFAULT_RATING + 400 * Math.log10(strengths[m])) : DEFAULT_RATING;
            });

            return stats;
        }

        function calculateEloRatings(initialStats, battles) {
            const stats = JSON.parse(JSON.stringify(initialStats)); 

            battles.forEach(b => {
                const model_a = b.match?.model_a?.trim().toLowerCase();
                const model_b = b.match?.model_b?.trim().toLowerCase();
                const winner = b.winner?.trim().toLowerCase();
                if (!model_a || !model_b || !winner || !stats[model_a] || !stats[model_b]) return;

                const ratingA = stats[model_a].rating;
                const ratingB = stats[model_b].rating;

                const expectedA = 1 / (1 + Math.pow(10, (ratingB - ratingA) / 400));
                const expectedB = 1 - expectedA;

                let actualA, actualB;
                if (winner === model_a) { actualA = 1; actualB = 0; stats[model_a].wins++; stats[model_b].losses++; } 
                else if (winner === model_b) { actualA = 0; actualB = 1; stats[model_b].wins++; stats[model_a].losses++; }
                else if (winner === 'tie') { actualA = 0.5; actualB = 0.5; stats[model_a].ties++; stats[model_b].ties++; }
                else { return; }

                stats[model_a].rating = Math.round(ratingA + ELO_K_FACTOR * (actualA - expectedA));
                stats[model_b].rating = Math.round(ratingB + ELO_K_FACTOR * (actualB - expectedB));
                stats[model_a].matches++; stats[model_b].matches++;
            });
            return stats;
        }

        function renderLeaderboard(stats) {
            const statsArray = Object.values(stats).map(s => ({...s, winrate: s.matches > 0 ? (s.wins / s.matches) : 0 }));
            const direction = sortDirection === 'asc' ? 1 : -1;
            statsArray.sort((a, b) => {
                if (a[currentSortKey] < b[currentSortKey]) return -1 * direction;
                if (a[currentSortKey] > b[currentSortKey]) return 1 * direction;
                return 0;
            });

            if (statsArray.length === 0) {
                leaderboardContainer.innerHTML = '<li>No battle data loaded.</li>';
            } else {
                leaderboardContainer.innerHTML = statsArray.map((model, index) => {
                    const rank = index + 1;
                    const rankClass = rank <= 3 ? `rank-${rank}` : '';
                    return `
                        <li>
                            <span class="rank ${rankClass}">${rank}</span>
                            <div class="model-details">
                                <div class="model-name">${model.name}</div>
                                <div class="stats-row">
                                    <span class="rating"><strong>${model.rating}</strong></span>
                                    <span>${model.wins}W / ${model.losses}L / ${model.ties}T</span>
                                    <span>${(model.winrate * 100).toFixed(1)}%</span>
                                    <span>${model.matches} matches</span>
                                </div>
                            </div>
                        </li>`;
                }).join('');
            }
            updateSortButtons();
        }

        function renderEditor() {
            const models = new Set();
            jsonData.forEach(entry => {
                const modelA = entry.match?.model_a?.trim();
                const modelB = entry.match?.model_b?.trim();
                if (modelA) models.add(modelA);
                if (modelB) models.add(modelB);
            });
            updateDatalists(models);

            if (jsonData.length === 0) {
                editorContainer.innerHTML = `<div class="empty-state"><p>No battles yet. Click "+ Add Entry" or "Load File".</p></div>`;
            } else {
                editorContainer.innerHTML = [...jsonData].reverse().map((entry, reverseIndex) => {
                    const originalIndex = jsonData.length - 1 - reverseIndex;
                    return `
                    <div class="card">
                        <div class="card-header">
                            <h3>Entry #${originalIndex + 1}</h3>
                            <button class="btn btn-danger" onclick="deleteEntry(${originalIndex})">Delete</button>
                        </div>
                        <div class="card-body">
                            <div class="form-group"><label>Task</label><textarea oninput="updateData(${originalIndex}, 'task', this.value)">${entry.task || ''}</textarea></div>
                            <div class="form-group-grid">
                                <div class="form-group"><label>Model A</label><input type="text" list="model-names-list" value="${entry.match?.model_a || ''}" oninput="updateData(${originalIndex}, 'match.model_a', this.value)"></div>
                                <div class="form-group"><label>Model B</label><input type="text" list="model-names-list" value="${entry.match?.model_b || ''}" oninput="updateData(${originalIndex}, 'match.model_b', this.value)"></div>
                            </div>
                             <div class="form-group"><label>Winner (or "tie")</label><input type="text" list="model-names-list" value="${entry.winner || ''}" oninput="updateData(${originalIndex}, 'winner', this.value)"></div>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        function updateSortButtons() {
            document.querySelectorAll('.sort-btn').forEach(btn => {

                const key = btn.onclick.toString().match(/'([^']+)'/)[1];
                btn.classList.remove('active');
                const arrowSpan = btn.querySelector('span');
                if (key === currentSortKey) {
                    btn.classList.add('active');
                    arrowSpan.textContent = sortDirection === 'desc' ? '‚ñº' : '‚ñ≤';
                } else {
                    arrowSpan.textContent = '';
                }
            });
        }

        function updateDatalists(models) {
            modelDatalist.innerHTML = Array.from(models).map(m => `<option value="${m}"></option>`).join('');
        }

        function processDataAndRender() {
            const initialStats = getInitialStats(jsonData);
            const calculationFn = currentRankingSystem === 'bt' ? calculateBradleyTerryRatings : calculateEloRatings;
            const finalStats = calculationFn(initialStats, jsonData);
            renderLeaderboard(finalStats);
            renderEditor();
            saveStateToLocalStorage();
        }

        function setRankingSystem(system) {
            currentRankingSystem = system;
            document.getElementById('select-bt').classList.toggle('active', system === 'bt');
            document.getElementById('select-elo').classList.toggle('active', system === 'elo');
            processDataAndRender();
        }

        function setSortOrder(key) {
            if (currentSortKey === key) {
                sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
            } else {
                currentSortKey = key;
                sortDirection = 'desc';
            }
            processDataAndRender();
        }

        function updateData(index, key, value) {
            const keys = key.split('.');
            let obj = jsonData[index];
            keys.forEach((k, i) => {
                if (i === keys.length - 1) obj[k] = value;
                else {
                    if (!obj[k]) obj[k] = {};
                    obj = obj[k];
                }
            });

        }

        function addEntry() {
            jsonData.push({ task: "", match: { model_a: "", model_b: "" }, winner: "" });
            renderEditor();
            const newCard = editorContainer.querySelector('.card');
            if(newCard) newCard.scrollIntoView({ behavior: 'smooth' });
        }

        function deleteEntry(index) {
            if (confirm(`Are you sure you want to delete Entry #${index + 1}?`)) {
                jsonData.splice(index, 1);
                processDataAndRender();
            }
        }

        function saveStateToLocalStorage() {
            try { localStorage.setItem('llmBattleData', JSON.stringify(jsonData)); } 
            catch (e) { console.error("Failed to save to localStorage", e); }
        }

        function loadStateFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('llmBattleData');
                if (savedData) jsonData = JSON.parse(savedData);
            } catch (e) {
                console.error("Failed to load from localStorage", e);
                jsonData = [];
            }
        }

        function showExportModal() {
            jsonOutput.value = JSON.stringify(jsonData, null, 2);
            exportModal.style.display = "block";
        }
        function closeExportModal() { exportModal.style.display = "none"; }
        function copyJsonToClipboard(button) {
            navigator.clipboard.writeText(jsonOutput.value).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            }).catch(err => alert('Failed to copy JSON: ' + err));
        }
        function exportToFile() {
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'battle_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    jsonData = JSON.parse(e.target.result);
                    if (!Array.isArray(jsonData)) throw new Error('JSON data must be an array.');
                    processDataAndRender();
                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                } finally {
                    fileInput.value = '';
                }
            };
            reader.readAsText(file);
        }

        fileInput.addEventListener('change', handleFileLoad);
        window.onclick = function(event) { if (event.target == exportModal) closeExportModal(); }
        document.addEventListener('DOMContentLoaded', () => {
            loadStateFromLocalStorage();
            processDataAndRender();
        });

    </script>
</body>
</html>
